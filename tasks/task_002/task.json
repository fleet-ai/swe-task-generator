{
  "instance_id": "marshmallow-code-marshmallow-2892",
  "repo": "marshmallow-code/marshmallow",
  "base_commit": "d07bf5e3d218cd5ffa1fcd1dce411f7a5c88e256",
  "head_commit": "8dc078e2b86312988e5f7ed32849ae0788779e81",
  "problem_statement": "# Issue #2891: ValidationError with uppercase `file` URLs\n\n## Issue Description\nI noticed that when a file URL uses an uppercase scheme (FILE), fields.Url raises a ValidationError, even though the exact same URL with a lowercase scheme (file) works fine. Since URL schemes are  case-insensitive, I\u2019d expect either both to be accepted or both to be rejected.\n\nFor example, HTTPS:// and https:// both work without any issues. This seems related to marshmallow issue #2249 and PR #2800. I\u2019m happy to open a PR to fix this if it makes sense.\n\n## Reproducing Code Example\n\n```\nfrom marshmallow import Schema, fields\n\nclass MySchema(Schema):\n    url = fields.Url(schemes={\"file\"})\n\nMySchema().load({\"url\": \"FILE:///path/to/somefile.txt\"})\n```\n\n## Expected Result\n```\n{\"url\": \"FILE:///path/to/somefile.txt\"}\n```\n## Actual Behavior\n```\nTraceback (most recent call last):\n  File \"test.py\", line 6, in <module>\n    MySchema().load({\"url\": \"FILE:///path/to/somefile.txt\"})\n  File \".../site-packages/marshmallow/schema.py\", line 730, in load\n    return self._do_load(\n  File \".../site-packages/marshmallow/schema.py\", line 938, in _do_load\n    raise exc marshmallow.exceptions.ValidationError: {'url': ['Not a valid URL.']}\n```\n\n\n\n---\n\n# Pull Request #2892: fix: handle uppercase `file` URLs \n\nFix #2891\n\n## Files Changed\n\n- src/marshmallow/validate.py\n- tests/test_validate.py",
  "gold_patch": "diff --git a/src/marshmallow/validate.py b/src/marshmallow/validate.py\n--- a/src/marshmallow/validate.py\n+++ b/src/marshmallow/validate.py\n@@ -214,8 +214,8 @@ def __call__(self, value: str) -> str:\n \n         # Hostname is optional for file URLS. If absent it means `localhost`.\n         # Fill it in for the validation if needed\n-        if scheme == \"file\" and value.startswith(\"file:///\"):\n-            matched = regex.search(value.replace(\"file:///\", \"file://localhost/\", 1))\n+        if scheme == \"file\" and value.lower().startswith(\"file:///\"):\n+            matched = regex.search(\"file://localhost/\" + value[8:])\n         else:\n             matched = regex.search(value)\n \ndiff --git a/tests/test_validate.py b/tests/test_validate.py\n--- a/tests/test_validate.py\n+++ b/tests/test_validate.py\n@@ -224,6 +224,14 @@ def test_url_custom_scheme_case_insensitive():\n         \"file:///tmp/test%20file.txt\",\n         \"file:///\",\n         \"file://localhost/\",\n+        \"FILE:///tmp/tmp1234\",\n+        \"FILE://localhost/tmp/tmp1234\",\n+        \"FILE:///C:/Users/test/file.txt\",\n+        \"FILE://localhost/C:/Program%20Files/file.exe\",\n+        \"FILE:///home/user/documents/test.pdf\",\n+        \"FILE:///tmp/test%20file.txt\",\n+        \"FILE:///\",\n+        \"FILE://localhost/\",\n     ),\n )\n def test_url_accepts_valid_file_urls(valid_url):",
  "test_files": [
    "tests/test_validate.py"
  ],
  "changed_files": [
    "src/marshmallow/validate.py",
    "tests/test_validate.py"
  ],
  "image_name": "erranli/swe-task-marshmallow-code-marshmallow-2892:latest",
  "eval_script": "#!/bin/bash\nset -e\n\n# Set PYTHONPATH to include src directory\nexport PYTHONPATH=src:$PYTHONPATH\n\n# Install project with test dependencies\npip install -e \".[tests]\" 2>/dev/null || pip install -e \".[dev]\" 2>/dev/null || pip install -e . 2>/dev/null || true\npip install pytest simplejson 2>/dev/null || true\n\n# Run the specific test that was modified in the patch\npytest tests/test_validate.py::test_url_accepts_valid_file_urls -xvs",
  "pr_number": 2892,
  "pr_title": "fix: handle uppercase `file` URLs ",
  "merged": true,
  "created_at": "2026-01-10T07:23:42+00:00",
  "generation_method": "agentic",
  "test_patch": "diff --git a/tests/test_validate.py b/tests/test_validate.py\n--- a/tests/test_validate.py\n+++ b/tests/test_validate.py\n@@ -224,6 +224,14 @@ def test_url_custom_scheme_case_insensitive():\n         \"file:///tmp/test%20file.txt\",\n         \"file:///\",\n         \"file://localhost/\",\n+        \"FILE:///tmp/tmp1234\",\n+        \"FILE://localhost/tmp/tmp1234\",\n+        \"FILE:///C:/Users/test/file.txt\",\n+        \"FILE://localhost/C:/Program%20Files/file.exe\",\n+        \"FILE:///home/user/documents/test.pdf\",\n+        \"FILE:///tmp/test%20file.txt\",\n+        \"FILE:///\",\n+        \"FILE://localhost/\",\n     ),\n )\n def test_url_accepts_valid_file_urls(valid_url):",
  "fix_patch": "diff --git a/src/marshmallow/validate.py b/src/marshmallow/validate.py\n--- a/src/marshmallow/validate.py\n+++ b/src/marshmallow/validate.py\n@@ -214,8 +214,8 @@ def __call__(self, value: str) -> str:\n \n         # Hostname is optional for file URLS. If absent it means `localhost`.\n         # Fill it in for the validation if needed\n-        if scheme == \"file\" and value.startswith(\"file:///\"):\n-            matched = regex.search(value.replace(\"file:///\", \"file://localhost/\", 1))\n+        if scheme == \"file\" and value.lower().startswith(\"file:///\"):\n+            matched = regex.search(\"file://localhost/\" + value[8:])\n         else:\n             matched = regex.search(value)\n \n"
}