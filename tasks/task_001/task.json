{
  "instance_id": "marshmallow-code-marshmallow-2894",
  "repo": "marshmallow-code/marshmallow",
  "base_commit": "ba8b512b24ebf4789099f1afafe9256b1bda950e",
  "head_commit": "9a5e935e2b7e28efd93ec15fafabc1e17ed50970",
  "problem_statement": "# Issue #2868: `fields.Constant` rejects `None` constant values during load\n\nWhen that constant is `None`, loading any payload that contains null triggers `ValidationError: Field may not be null`. The stems from the initialization order: `Field.__init__` sets `allow_none` based on the (yet-unknown) `load_default`, and only afterwards `Constant.__init__` assigns the actual constant/load_default.\n\n```python\nfrom marshmallow import Schema, fields\n\nclass DemoSchema(Schema):\n    # Should always load/dump None, independent of input\n    sentinel = fields.Constant(None)\n\nschema = DemoSchema()\n\nassert schema.dump({\"sentinel\": \"anything\"})[\"sentinel\"] is None\n\nschema.load({\"sentinel\": None})\n```\n\n```\nTraceback (most recent call last):\n  File \"/data/src/test.py\", line 11, in <module>\n    schema.load({\"sentinel\": None})\n  File \"/home/hdd/miniconda3/envs/py312/lib/python3.12/site-packages/marshmallow/schema.py\", line 730, in load\n    return self._do_load(\n           ^^^^^^^^^^^^^^\n  File \"/home/hdd/miniconda3/envs/py312/lib/python3.12/site-packages/marshmallow/schema.py\", line 938, in _do_load\n    raise exc\nmarshmallow.exceptions.ValidationError: {'sentinel': ['Field may not be null.']}\n```\n\n> Note: This issue was identified by an automated testing tool for academic research and manually verified. If you have any concerns about this type of reporting, please let me know, and I will adjust my workflow accordingly.\n\n---\n\n# Pull Request #2894: Fix Constant field rejecting None values during load\n\n# PR summary: \r\n`Constant(None)` was rejecting null values during load with \"Field may not be null\" because `allow_none` was being inferred before the constant value was assigned. Moving the default assignments before `super().__init__()`, lets the base class correctly infer `allow_none=True` when the constant is `None`.\r\n\r\nFixes #2868.\n\n## Files Changed\n\n- AUTHORS.rst\n- CHANGELOG.rst\n- src/marshmallow/fields.py\n- tests/test_deserialization.py",
  "gold_patch": "diff --git a/AUTHORS.rst b/AUTHORS.rst\n--- a/AUTHORS.rst\n+++ b/AUTHORS.rst\n@@ -183,3 +183,4 @@ Contributors (chronological)\n - Xiao `@T90REAL <https://github.com/T90REAL>`_\n - jfo `@jafournier <https://github.com/jafournier>`_\n - thanhlecongg `@thanhlecongg <https://github.com/thanhlecongg>`_\n+- Emmanuel Ferdman  `@emmanuel-ferdman  <https://github.com/emmanuel-ferdman>`_\ndiff --git a/CHANGELOG.rst b/CHANGELOG.rst\n--- a/CHANGELOG.rst\n+++ b/CHANGELOG.rst\n@@ -1,6 +1,14 @@\n Changelog\n =========\n \n+unreleased\n+----------\n+\n+Bug fixes:\n+\n+- Fix behavior of ``fields.Contant(None)`` (:issue:`2868`).\n+  Thanks :user:`T90REAL` for reporting and `emmanuel-ferdman` for the fix.\n+\n \n 4.2.1 (2026-01-23)\n ------------------\ndiff --git a/src/marshmallow/fields.py b/src/marshmallow/fields.py\n--- a/src/marshmallow/fields.py\n+++ b/src/marshmallow/fields.py\n@@ -2065,10 +2065,10 @@ class Constant(Field[_ContantT]):\n     _CHECK_ATTRIBUTE = False\n \n     def __init__(self, constant: _ContantT, **kwargs: Unpack[_BaseFieldKwargs]):\n+        kwargs[\"load_default\"] = constant\n+        kwargs[\"dump_default\"] = constant\n         super().__init__(**kwargs)\n         self.constant = constant\n-        self.load_default = constant\n-        self.dump_default = constant\n \n     def _serialize(self, value, *args, **kwargs) -> _ContantT:\n         return self.constant\ndiff --git a/tests/test_deserialization.py b/tests/test_deserialization.py\n--- a/tests/test_deserialization.py\n+++ b/tests/test_deserialization.py\n@@ -1413,6 +1413,15 @@ class MySchema(Schema):\n         assert sch.load({})[\"foo\"] == 42\n         assert sch.load({\"foo\": 24})[\"foo\"] == 42\n \n+    def test_constant_none_allows_none_value(self):\n+        class MySchema(Schema):\n+            foo = fields.Constant(None)\n+\n+        sch = MySchema()\n+        assert sch.load({\"foo\": None})[\"foo\"] is None\n+        assert sch.load({})[\"foo\"] is None\n+        assert sch.load({\"foo\": \"ignored\"})[\"foo\"] is None\n+\n     def test_field_deserialization_with_user_validator_function(self):\n         field = fields.String(validate=predicate(lambda s: s.lower() == \"valid\"))\n         assert field.deserialize(\"Valid\") == \"Valid\"",
  "test_files": [
    "tests/test_deserialization.py"
  ],
  "changed_files": [
    "AUTHORS.rst",
    "CHANGELOG.rst",
    "src/marshmallow/fields.py",
    "tests/test_deserialization.py"
  ],
  "image_name": "erranli/swe-task-marshmallow-code-marshmallow-2894:latest",
  "eval_script": "#!/bin/bash\nset -e\npip install -e \".[tests]\" 2>/dev/null || pip install -e . 2>/dev/null || true\npytest tests/test_deserialization.py::TestFieldDeserialization::test_constant_none_allows_none_value -xvs",
  "pr_number": 2894,
  "pr_title": "Fix Constant field rejecting None values during load",
  "merged": true,
  "created_at": "2026-01-27T23:27:55+00:00",
  "generation_method": "agentic",
  "test_patch": "diff --git a/tests/test_deserialization.py b/tests/test_deserialization.py\n--- a/tests/test_deserialization.py\n+++ b/tests/test_deserialization.py\n@@ -1413,6 +1413,15 @@ class MySchema(Schema):\n         assert sch.load({})[\"foo\"] == 42\n         assert sch.load({\"foo\": 24})[\"foo\"] == 42\n \n+    def test_constant_none_allows_none_value(self):\n+        class MySchema(Schema):\n+            foo = fields.Constant(None)\n+\n+        sch = MySchema()\n+        assert sch.load({\"foo\": None})[\"foo\"] is None\n+        assert sch.load({})[\"foo\"] is None\n+        assert sch.load({\"foo\": \"ignored\"})[\"foo\"] is None\n+\n     def test_field_deserialization_with_user_validator_function(self):\n         field = fields.String(validate=predicate(lambda s: s.lower() == \"valid\"))\n         assert field.deserialize(\"Valid\") == \"Valid\"",
  "fix_patch": "diff --git a/src/marshmallow/fields.py b/src/marshmallow/fields.py\n--- a/src/marshmallow/fields.py\n+++ b/src/marshmallow/fields.py\n@@ -2065,10 +2065,10 @@ class Constant(Field[_ContantT]):\n     _CHECK_ATTRIBUTE = False\n \n     def __init__(self, constant: _ContantT, **kwargs: Unpack[_BaseFieldKwargs]):\n+        kwargs[\"load_default\"] = constant\n+        kwargs[\"dump_default\"] = constant\n         super().__init__(**kwargs)\n         self.constant = constant\n-        self.load_default = constant\n-        self.dump_default = constant\n \n     def _serialize(self, value, *args, **kwargs) -> _ContantT:\n         return self.constant\n"
}